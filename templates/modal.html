<!-- Ubah z-50 menjadi z-[1000] agar modal selalu di atas navbar -->
<div id="crudModal" class="hidden fixed inset-0 z-[1000] w-full h-full flex items-center justify-center bg-gray-900 bg-opacity-60 backdrop-blur-sm transition-opacity duration-300 opacity-0">
  <div id="crudModalContent" class="relative bg-white rounded-2xl shadow-2xl w-full max-w-2xl mx-4 sm:mx-0 transform scale-95 transition-transform duration-300 flex flex-col max-h-[90vh]">
    
    <!-- Modal Header -->
    <div class="flex items-center justify-between px-8 py-6 border-b border-gray-100">
      <div>
        <h3 id="modalTitle" class="text-2xl font-bold text-gray-900">
          Create New Product
        </h3>
        <p class="text-sm text-gray-500 mt-1">Fill in the details below to update your catalog.</p>
      </div>
      <button type="button" class="text-gray-400 bg-transparent hover:bg-gray-100 hover:text-gray-900 rounded-lg p-2 transition-colors" onclick="hideModal()">
        <svg aria-hidden="true" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        <span class="sr-only">Close modal</span>
      </button>
    </div>
    
    <!-- Modal Body (Scrollable) -->
    <div class="px-8 py-6 overflow-y-auto custom-scrollbar">
      <form id="productForm" class="space-y-6">
        {% csrf_token %}
        <input type="hidden" id="productId" name="productId"> <!-- Hidden ID untuk Edit -->
        
        <!-- Name Input -->
        <div>
          <label for="name" class="block text-sm font-semibold text-gray-700 mb-2">Product Name</label>
          <input type="text" id="name" name="name" 
            class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl text-gray-900 focus:outline-none focus:ring-2 focus:ring-[#d74a1f] focus:border-transparent transition-all placeholder-gray-400" 
            placeholder="e.g., Manchester United Home Kit 23/24" required>
        </div>
        
        <!-- Grid: Price & Category -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <label for="price" class="block text-sm font-semibold text-gray-700 mb-2">Price (IDR)</label>
                <div class="relative">
                    <span class="absolute left-4 top-3.5 text-gray-500 font-medium">Rp</span>
                    <input type="number" name="price" id="price" 
                        class="w-full pl-12 pr-4 py-3 bg-gray-50 border border-gray-200 rounded-xl text-gray-900 focus:outline-none focus:ring-2 focus:ring-[#d74a1f] focus:border-transparent transition-all" 
                        placeholder="0" required>
                </div>
            </div>
            <div>
                <label for="category" class="block text-sm font-semibold text-gray-700 mb-2">Category</label>
                <div class="relative">
                    <select id="category" name="category" 
                        class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl text-gray-900 appearance-none focus:outline-none focus:ring-2 focus:ring-[#d74a1f] focus:border-transparent transition-all cursor-pointer" required>
                        <option value="" disabled selected>Select category</option>
                        <option value="jersey">Jersey</option>
                        <option value="shoes">Football Shoes</option>
                        <option value="ball">Football</option>
                        <option value="equipment">Training Equipment</option>
                        <option value="accessories">Accessories</option>
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-gray-500">
                        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </div>
                </div>
            </div>
        </div>

        <!-- Description -->
        <div>
          <label for="description" class="block text-sm font-semibold text-gray-700 mb-2">Description</label>
          <textarea id="description" name="description" rows="4" 
            class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl text-gray-900 focus:outline-none focus:ring-2 focus:ring-[#d74a1f] focus:border-transparent transition-all placeholder-gray-400 resize-none" 
            placeholder="Describe the product details, material, and features..." required></textarea>
        </div>
        
        <!-- Thumbnail -->
        <div>
          <label for="thumbnail" class="block text-sm font-semibold text-gray-700 mb-2">Image URL</label>
          <input type="url" id="thumbnail" name="thumbnail" 
            class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl text-gray-900 focus:outline-none focus:ring-2 focus:ring-[#d74a1f] focus:border-transparent transition-all placeholder-gray-400" 
            placeholder="https://example.com/image.jpg">
            <p class="mt-1 text-xs text-gray-500">Provide a direct link to the product image.</p>
        </div>
        
        <!-- Featured Checkbox -->
        <div class="flex items-center p-4 border border-gray-200 rounded-xl bg-gray-50/50">
            <input id="is_featured" name="is_featured" type="checkbox" 
                class="w-5 h-5 text-[#d74a1f] border-gray-300 rounded focus:ring-[#d74a1f] cursor-pointer">
            <label for="is_featured" class="ml-3 flex flex-col cursor-pointer">
                <span class="text-sm font-semibold text-gray-900">Featured Product</span>
                <span class="text-xs text-gray-500">Show this product on the top section</span>
            </label>
        </div>
      </form>
    </div>
    
    <!-- Modal Footer -->
    <div class="flex flex-col sm:flex-row gap-3 px-8 py-6 border-t border-gray-100 bg-gray-50 rounded-b-2xl">
      <button type="button" onclick="hideModal()" 
        class="order-2 sm:order-1 flex-1 px-6 py-3 border border-gray-300 text-gray-700 rounded-xl font-medium hover:bg-white hover:border-gray-400 transition-all focus:outline-none focus:ring-2 focus:ring-gray-200">
        Cancel
      </button>
      <button type="submit" id="submitProductBtn" form="productForm" 
        class="order-1 sm:order-2 flex-1 bg-[#d74a1f] text-white px-6 py-3 rounded-xl font-bold hover:bg-[#c03e17] shadow-lg shadow-orange-200 hover:shadow-orange-300 transition-all transform hover:-translate-y-0.5 focus:outline-none focus:ring-2 focus:ring-[#d74a1f] focus:ring-offset-2">
        Save Product
      </button>
    </div>
    
  </div>
</div>

<script>
  // Global State
  let isEditMode = false;
  let currentEditId = null;

  const modal = document.getElementById('crudModal');
  const modalContent = document.getElementById('crudModalContent');
  const modalTitle = document.getElementById('modalTitle');
  const submitBtn = document.getElementById('submitProductBtn');
  const productForm = document.getElementById('productForm');

  function showModal() {
      // RESET FORM untuk Mode CREATE
      isEditMode = false;
      currentEditId = null;
      productForm.reset();
      
      modalTitle.textContent = "Create New Product";
      submitBtn.textContent = "Create Product";
      submitBtn.className = "order-1 sm:order-2 flex-1 bg-[#d74a1f] text-white px-6 py-3 rounded-xl font-bold hover:bg-[#c03e17] shadow-lg shadow-orange-200 hover:shadow-orange-300 transition-all transform hover:-translate-y-0.5 focus:outline-none focus:ring-2 focus:ring-[#d74a1f] focus:ring-offset-2";

      // Animation Show
      modal.classList.remove('hidden'); 
      setTimeout(() => {
        modal.classList.remove('opacity-0');
        modalContent.classList.remove('scale-95');
        modalContent.classList.add('scale-100');
      }, 50); 
  }

  // FUNGSI BARU: Untuk Membuka Modal dalam Mode EDIT
  async function showEditModal(productId) {
      isEditMode = true;
      currentEditId = productId;
      
      // Update UI
      modalTitle.textContent = "Edit Product";
      submitBtn.textContent = "Update Product";
      // Ganti warna tombol biar user sadar ini Edit (opsional, tapi bagus untuk UX)
      submitBtn.className = "order-1 sm:order-2 flex-1 bg-gray-900 text-white px-6 py-3 rounded-xl font-bold hover:bg-gray-800 shadow-lg shadow-gray-200 hover:shadow-gray-300 transition-all transform hover:-translate-y-0.5 focus:outline-none focus:ring-2 focus:ring-gray-900 focus:ring-offset-2";

      // Fetch Data Produk Lama
      try {
        const response = await fetch(`/json/${productId}/`);
        if (!response.ok) throw new Error('Failed to fetch product');
        const data = await response.json();

        // Populate Form
        document.getElementById('productId').value = data.id;
        document.getElementById('name').value = data.name;
        document.getElementById('price').value = data.price;
        document.getElementById('description').value = data.description;
        document.getElementById('category').value = data.category;
        document.getElementById('thumbnail').value = data.thumbnail;
        document.getElementById('is_featured').checked = data.is_featured;

        // Show Modal
        modal.classList.remove('hidden'); 
        setTimeout(() => {
            modal.classList.remove('opacity-0');
            modalContent.classList.remove('scale-95');
            modalContent.classList.add('scale-100');
        }, 50); 

      } catch (error) {
        alert("Error fetching product data: " + error.message);
      }
  }

  function hideModal() {
      modal.classList.add('opacity-0');
      modalContent.classList.remove('scale-100');
      modalContent.classList.add('scale-95');

      setTimeout(() => {
        modal.classList.add('hidden');
      }, 300); 
  }

  // Unified Submit Function
  async function handleFormSubmit(e) {
      e.preventDefault();
      
      // Disable button to prevent double submit
      const originalBtnText = submitBtn.textContent;
      submitBtn.disabled = true;
      submitBtn.textContent = isEditMode ? "Updating..." : "Creating...";

      const formData = new FormData(productForm);
      
      // Tentukan URL dan Method berdasarkan Mode
      let url = "{% url 'main:add_product_entry_ajax' %}";
      
      if (isEditMode && currentEditId) {
          // Construct Edit URL manually or use a JS variable placeholder
          url = `/product/${currentEditId}/edit/`; 
      }

      try {
          const response = await fetch(url, {
              method: "POST",
              body: formData,
              headers: {
                  // Tambahkan header khusus jika edit (Django view edit biasanya cek POST standard, tapi fetch ini ngirim FormData)
                  // View edit_product kamu sudah handle form.save(), jadi aman.
              }
          });

          if (response.ok) {
              hideModal();
              productForm.reset();
              const actionType = isEditMode ? "updated" : "added";
              showToast('Success!', `Product has been ${actionType} successfully.`, 'success');
              
              // Refresh List Produk di Main Page
              document.dispatchEvent(new CustomEvent('productAdded')); 
          } else {
              const result = await response.json();
              alert("Failed: " + (result.error || "Unknown error"));
          }
      } catch (error) {
          alert("Network error: " + error.message);
      } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = originalBtnText;
      }
  }

  // Bind Event Listener
  productForm.addEventListener("submit", handleFormSubmit);

</script>

<style>
  /* Custom scrollbar for modal body */
  .custom-scrollbar::-webkit-scrollbar {
    width: 6px;
  }
  .custom-scrollbar::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
  }
  .custom-scrollbar::-webkit-scrollbar-thumb {
    background: #d1d5db;
    border-radius: 4px;
  }
  .custom-scrollbar::-webkit-scrollbar-thumb:hover {
    background: #9ca3af;
  }
</style>